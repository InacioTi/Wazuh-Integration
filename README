# Automation Wazuh

# SRV-WAZUH-SIEM

[https://www.youtube.com/watch?v=ksFPu8DTDAs](https://www.youtube.com/watch?v=ksFPu8DTDAs)


# Guia instalaçõa do wazuh

1 ° Subir uma instancia Ubunto server 20 ou Centos 7 com 8GB de memoria e 2 CPU

2 ° Configurar ip static

3 ° Instalar o wazuh curl -sO [https://packages.wazuh.com/4.3/wazuh-install.sh](https://packages.wazuh.com/4.3/wazuh-install.sh) && sudo bash ./wazuh-install.sh -a

4 ° Baixar o script para alterar senha
curl -so [wazuh-passwords-tool.sh](http://wazuh-passwords-tool.sh/) [https://packages.wazuh.com/4.3/wazuh-passwords-tool.sh](https://packages.wazuh.com/4.3/wazuh-passwords-tool.sh)
exemplo: bash [wazuh-passwords-tool.sh](http://wazuh-passwords-tool.sh/) -u admin -p 'SENHA'

5 ° Criar grupo em wazuh > Management > Groups

Editar grupo e colocar
<agent_config>
<labels>
<label key="group">Windows</label>
</labels>
<syscheck>
<directories check_all="yes" realtime="yes">/media/user/software</directories>
<directories check_all="yes" realtime="yes">C:\User\*\Downloads</directories>
<directories check_all="yes" realtime="yes">%PROGRAMDATA%\Microsoft\Start menu\Programs\Startup</directories>
</syscheck>
<localfile>
<location>Microsoft-Windows-Windows Defender/Operational</location>
<log_format>eventchannel</log_format>
</localfile>
</agent_config>

6 ° Fazer as configurações iniciais em wazuh > Management > Configuration

<!-- Envio do Syslog para Wazuh -->
<remote>
<connection>syslog</connection>
<port>514</port>
<protocol>udp</protocol>
<allowed-ips>192.168.20.0/24</allowed-ips>
</remote>

<!-- Integração com VirusTotal -->
<integration>
<name>virustotal</name>
<api_key>KEYAQUI</api_key> <!-- Replace with your VirusTotal API key -->
<group>syscheck</group>
<alert_format>json</alert_format>
</integration>

<!-- Habilitar a colecta de vuln -->
<vulnerability-detector>
<enabled>yes</enabled>
<interval>5m</interval>
<min_full_scan_interval>6h</min_full_scan_interval>
<run_on_start>yes</run_on_start>

```
<!-- Ubuntu OS vulnerabilities -->
<provider name="canonical">
  <enabled>yes</enabled>
  <os>trusty</os>
  <os>xenial</os>
  <os>bionic</os>
  <os>focal</os>
  <os>jammy</os>
  <update_interval>1h</update_interval>
</provider>

<!-- Debian OS vulnerabilities -->
<provider name="debian">
  <enabled>yes</enabled>
  <os>stretch</os>
  <os>buster</os>
  <os>bullseye</os>
  <update_interval>1h</update_interval>
</provider>

<!-- RedHat OS vulnerabilities -->
<provider name="redhat">
  <enabled>yes</enabled>
  <os>5</os>
  <os>6</os>
  <os>7</os>
  <os>8</os>
  <os>9</os>
  <update_interval>1h</update_interval>
</provider>

<!-- Amazon Linux OS vulnerabilities -->
<provider name="alas">
  <enabled>yes</enabled>
  <os>amazon-linux</os>
  <os>amazon-linux-2</os>
  <update_interval>1h</update_interval>
</provider>

<!-- Arch OS vulnerabilities -->
<provider name="arch">
  <enabled>yes</enabled>
  <update_interval>1h</update_interval>
</provider>

<!-- Windows OS vulnerabilities -->
<provider name="msu">
  <enabled>yes</enabled>
  <update_interval>1h</update_interval>
</provider>

<!-- Aggregate vulnerabilities -->
<provider name="nvd">
  <enabled>yes</enabled>
  <update_from_year>2010</update_from_year>
  <update_interval>1h</update_interval>
</provider>

```

</vulnerability-detector>

7 ° Baixar sysmon e baixar o xml [https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml](https://github.com/SwiftOnSecurity/sysmon-config/blob/master/sysmonconfig-export.xml)
ativar com o sysmon .\Sysmon64.exe  -accepteula -i sysmonconfig-export.xml
adcionar ao wazuh > Management > Configuration
<!-- Monitorar sysmon-->
<localfile>
<location>Microsoft-Windows-Sysmon/Operational</location>
<log_format>eventchannel</log_format>
</localfile>

8 ° Criar usaurio wazuh > Security > Internal users
Em roles, Criar uma role de somente leitura com o Cluster permissions (cluster_composite_ops_ro) adicionar * para index, em permisao Read, em tenat deixar global somente leitura, Depois mapear o usuario a esta regra
Editar permisão em wazuh > Security > Roles mapping - Criar perfil
Habilitar roles no terminal (nano /usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml) habilitar (run_as run_as:true)
systemctl restart wazuh-dashboard.service

# Alertas por e-mail no wazuh

# Em wazuh > management > configuration ou /var/ossec/etc/ossec.conf colocar as seguintes conf

<global>
<jsonout_output>yes</jsonout_output>
<alerts_log>yes</alerts_log>
<logall>no</logall>
<logall_json>no</logall_json>
#habiliar alerta por e-mail
<email_notification>yes</email_notification>
#colocar localhost por que usaremos postfix
<smtp_server>localhost</smtp_server>
#email que enviara os alertas
<email_from>teste@exemplo.com</email_from>
#email que recebera os alertas
<email_to>teste@exemplo.com</email_to>
<email_maxperhour>12</email_maxperhour>
<email_log_source>alerts.log</email_log_source>
<agents_disconnection_time>10m</agents_disconnection_time>
<agents_disconnection_alert_time>0</agents_disconnection_alert_time>
</global>

<alerts>
<log_alert_level>3</log_alert_level>
<email_alert_level>12</email_alert_level>
</alerts>

# Exemplo, na regra do ssh adcionei a linha <options>alert_by_email</options> que fara o envio indepentemente do nivel do alerta

```
/var/ossec/ruleset/rules/0095-sshd_rules.xml

```

# Instalr o postfix na maquina e configurar o envio de e-mail, (exemplo com outlook)

```
apt-get install postfix mailutils libsasl2-2 ca-certificates libsasl2-modules

```

### Configure o Postfix no arquivo /etc/postfix/main.cf adicionando estas linhas ao final do arquivo:

```
relayhost = [smtp.office365.com]:587
smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_sasl_security_options = noanonymous
smtp_tls_CAfile = /etc/ssl/certs/ca-certificates.crt
smtp_use_tls = yes

```

### Configure o endereço de e-mail e a senha:

```
echo [smtp.office365.com:587 USERNAME@gmail.com:PASSWORD > /etc/postfix/sasl_passwd
postmap /etc/postfix/sasl_passwd
chmod 400 /etc/postfix/sasl_passwd

```

### Proteja a senha do banco de dados:

```
chown root:root /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db
chmod 0600 /etc/postfix/sasl_passwd /etc/postfix/sasl_passwd.db

```

### restart

```
systemctl reload postfix

```

### Testanto o envio

```
echo "Test mail from postfix" | mail -s "Test Postfix" -r "seuemaildeenvio@teste.com" emailquereeceb@example.com

```

# Customizar os alertas em wazuh > management > configuration ou /var/ossec/etc/ossec.conf colocar as seguintes conf

## Adcionar a customização de e-mail por id

<!-- Customizar alertas por email filtrando por id da regra -->
<email_alerts>
<email_to>teste@exemplo.com</email_to>
<rule_id>515, 516</rule_id>
<do_not_delay />
</email_alerts>

## Posso integrar um script para customizar o alerta de e-mail

<!-- Integração com E-mail Personalizado -->

<integration>
<name>custom-email-alerts</name>
<hook_url>teste@exemplo.com</hook_url>
<rule_id>651,5760</rule_id>
<alert_format>json</alert_format>
</integration>

## Faço Download do script com wget:

wget [https://raw.githubusercontent.com/jctello/JCT-Wazuh/main/integrations/custom-email-alerts](https://raw.githubusercontent.com/jctello/JCT-Wazuh/main/integrations/custom-email-alerts) -O /var/ossec/integrations/[custom-email-alerts.py](http://custom-email-alerts.py/)

## Edito o arquvio adcionado o seguinte:

email_server = "localhost"
email_from = "teste@exemplo.com"

## Adicione o script personalizado para enviar emails em /var/ossec/integrations/custom-email-alerts e dê a ele a propriedade e as permissões corretas:

## Alertas por e-mail e dê a ele a propriedade e as permissões corretas:

chown root:ossec /var/ossec/integrations/custom-email-alerts

chmod 750 /var/ossec/integrations/custom-email-alerts 

## Modifique o script personalizado para incluir seus dados:

email_server = "[smtp.email.com](http://smtp.email.com/)" 

email_from = "[noreply@example.com](mailto:noreply@example.com)" 

## Modifique o assunto e a mensagem na função generate_msg conforme desejar. Reinicie o gerenciador do Wazuh para que as alterações tenham efeito:

systemctl restart wazuh-manager

## Verificar se deu certo

tail -f /var/ossec/logs/ossec.log | grep custom-

Observação  Desativar o <email_notification>yes</email_notification> na conf do wazuh caso vá usar o alerta personalizado

# Lembrar de habilitar e-mail de terceiro no provedor

Referencias em
[https://documentation.wazuh.com/current/user-manual/wazuh-dashboard/](https://documentation.wazuh.com/current/user-manual/wazuh-dashboard/)  rbac.html?highlight=internal+users#creating-and-setting-a-wazuh-read-only-user

[https://opensearch.org/docs/latest/security-plugin/access-control/users-roles/](https://opensearch.org/docs/latest/security-plugin/access-control/users-roles/)

[https://github.com/wazuh/wazuh/issues/12717](https://github.com/wazuh/wazuh/issues/12717)

[https://documentation.wazuh.com/current/user-manual/reference/ossec-conf/email-alerts.html](https://documentation.wazuh.com/current/user-manual/reference/ossec-conf/email-alerts.html)?
highlight=email

[https://www.youtube.com/watch?v=VH1dBTegbp4](https://www.youtube.com/watch?v=VH1dBTegbp4)

[https://benheater.com/hunting-with-wazuh-adding-context/](https://benheater.com/hunting-with-wazuh-adding-context/)

[https://medium.com/@MsDLeo/postfix-configuration-in-ubuntu-for-wazuh-4b422bcfba71](https://medium.com/@MsDLeo/postfix-configuration-in-ubuntu-for-wazuh-4b422bcfba71)

[https://wazuh.com/blog/how-to-send-email-notifications-with-wazuh/](https://wazuh.com/blog/how-to-send-email-notifications-with-wazuh/)

[https://groups.google.com/g/wazuh/c/UoaMOjG7SVI](https://groups.google.com/g/wazuh/c/UoaMOjG7SVI)

[https://www.reddit.com/r/Wazuh/comments/sem0gv/how_can_i_change_email_subject/](https://www.reddit.com/r/Wazuh/comments/sem0gv/how_can_i_change_email_subject/)
